# ============================================================================
# Deploy Platform Infrastructure
# ============================================================================
# This workflow deploys the complete xshopai platform infrastructure to the
# specified environment using Bicep modules published to the ACR.
#
# Prerequisites:
# 1. Bootstrap workflow must have run successfully (creates ACR)
# 2. Publish modules workflow must have run successfully (populates ACR)
#
# Deploys:
# - Resource group: rg-xshopai-{env}
# - Azure Container Apps Environment (platform for hosting apps)
# - Log Analytics Workspace
# - Managed Identity (for Container Apps)
# - Azure Key Vault
# - PostgreSQL Flexible Servers (3 instances):
#   * psql-xshopai-product-{env} for product-service
#   * psql-xshopai-user-{env} for user-service
#   * psql-xshopai-order-{env} for order-service
# - Cosmos DB (MongoDB API): cosmos-xshopai-{env} (shared)
#
# NOTE: This workflow deploys the PLATFORM infrastructure only.
# Microservices (Container Apps) are deployed separately via CI/CD pipelines.
#
# ============================================================================

name: Deploy Platform Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      location:
        description: 'Azure region'
        required: true
        default: 'swedencentral'
      dry_run:
        description: 'Dry run (what-if only, no deployment)'
        required: true
        default: true
        type: boolean

permissions:
  id-token: write
  contents: read

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

jobs:
  deploy-platform:
    name: Deploy Platform Infrastructure
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Service Principal Object ID
        id: sp-object-id
        run: |
          # Get the Object ID of the service principal performing the deployment
          # This allows the deploying identity to have admin access to Key Vault
          SP_OBJECT_ID=$(az ad sp show --id ${{ secrets.AZURE_CLIENT_ID }} --query id -o tsv)
          echo "object-id=$SP_OBJECT_ID" >> $GITHUB_OUTPUT
          echo "âœ… Service Principal Object ID: $SP_OBJECT_ID"

      - name: Set deployment name
        id: deployment-name
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "name=platform-infra-${TIMESTAMP}" >> $GITHUB_OUTPUT

      - name: Handle Soft-Deleted Key Vault Resources
        run: |
          echo "ðŸ” Checking for soft-deleted Key Vault resources..."
          
          # Define Key Vault name pattern (matches main.bicep naming)
          KV_NAME="kv-xshopai-${{ inputs.environment }}2"
          
          # Check if the Key Vault itself is soft-deleted
          DELETED_VAULT=$(az keyvault list-deleted --query "[?name=='$KV_NAME'].name" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$DELETED_VAULT" ]; then
            echo "âš ï¸ Found soft-deleted Key Vault: $KV_NAME"
            echo "ðŸ—‘ï¸ Purging soft-deleted Key Vault to allow recreation..."
            az keyvault purge --name "$KV_NAME" --no-wait || {
              echo "â³ Purge initiated. Waiting for completion..."
              sleep 30
            }
            echo "âœ… Key Vault purge initiated"
          else
            echo "âœ… No soft-deleted Key Vault found with name: $KV_NAME"
            
            # Even if the vault isn't deleted, secrets might be soft-deleted
            # This happens if you deleted and recreated the vault manually
            # Check if vault exists and has soft-deleted secrets
            VAULT_EXISTS=$(az keyvault show --name "$KV_NAME" --query "name" -o tsv 2>/dev/null || echo "")
            
            if [ -n "$VAULT_EXISTS" ]; then
              echo "ðŸ” Checking for soft-deleted secrets in existing vault..."
              
              # List soft-deleted secrets and recover them
              DELETED_SECRETS=$(az keyvault secret list-deleted --vault-name "$KV_NAME" --query "[].name" -o tsv 2>/dev/null || echo "")
              
              if [ -n "$DELETED_SECRETS" ]; then
                echo "âš ï¸ Found soft-deleted secrets, recovering them..."
                for SECRET_NAME in $DELETED_SECRETS; do
                  echo "  Recovering: $SECRET_NAME"
                  az keyvault secret recover --vault-name "$KV_NAME" --name "$SECRET_NAME" --no-wait 2>/dev/null || true
                done
                echo "â³ Waiting for secret recovery to complete..."
                sleep 15
                echo "âœ… Soft-deleted secrets recovered"
              else
                echo "âœ… No soft-deleted secrets found"
              fi
            fi
          fi

      - name: Validate Bicep template
        working-directory: azure/container-apps/bicep/${{ inputs.environment }}/platform
        run: |
          echo "ðŸ” Validating Bicep template..."
          az bicep build --file main.bicep
          echo "âœ… Template is valid"

      - name: Validate Parameter File
        working-directory: azure/container-apps/bicep/${{ inputs.environment }}/platform
        run: |
          echo "ðŸ” Validating parameter file..."
          az bicep build-params --file main.bicepparam
          echo "âœ… Parameter file is valid"

      - name: What-If Analysis
        working-directory: azure/container-apps/bicep/${{ inputs.environment }}/platform
        run: |
          echo "ðŸ”® Running what-if analysis..."
          az deployment sub what-if \
            --name "${{ steps.deployment-name.outputs.name }}" \
            --location "${{ inputs.location }}" \
            --template-file main.bicep \
            --parameters main.bicepparam \
            --parameters location='${{ inputs.location }}' \
            --parameters jwtSecret='${{ secrets.JWT_SECRET }}' \
            --parameters postgresAdminPassword='${{ secrets.POSTGRES_ADMIN_PASSWORD }}' \
            --parameters sqlAdminPassword='${{ secrets.SQL_SERVER_ADMIN_PASSWORD }}' \
            --parameters mysqlAdminPassword='${{ secrets.MYSQL_ADMIN_PASSWORD }}' \
            --parameters keyVaultAdminObjectId='${{ steps.sp-object-id.outputs.object-id }}' \
            --result-format FullResourcePayloads

      - name: Deploy Platform Infrastructure
        if: ${{ inputs.dry_run == false }}
        working-directory: azure/container-apps/bicep/${{ inputs.environment }}/platform
        run: |
          echo "ðŸš€ Deploying platform infrastructure..."
          echo "Environment: ${{ inputs.environment }}"
          echo "Location: ${{ inputs.location }}"
          echo ""
          
          az deployment sub create \
            --name "${{ steps.deployment-name.outputs.name }}" \
            --location "${{ inputs.location }}" \
            --template-file main.bicep \
            --parameters main.bicepparam \
            --parameters location='${{ inputs.location }}' \
            --parameters jwtSecret='${{ secrets.JWT_SECRET }}' \
            --parameters postgresAdminPassword='${{ secrets.POSTGRES_ADMIN_PASSWORD }}' \
            --parameters sqlAdminPassword='${{ secrets.SQL_SERVER_ADMIN_PASSWORD }}' \
            --parameters mysqlAdminPassword='${{ secrets.MYSQL_ADMIN_PASSWORD }}' \
            --parameters keyVaultAdminObjectId='${{ steps.sp-object-id.outputs.object-id }}' \
            --verbose

      - name: Get Deployment Outputs
        if: ${{ inputs.dry_run == false }}
        id: outputs
        run: |
          echo "ðŸ“‹ Fetching deployment outputs..."
          OUTPUTS=$(az deployment sub show \
            --name "${{ steps.deployment-name.outputs.name }}" \
            --query "properties.outputs" \
            --output json)
          
          echo "Deployment outputs:"
          echo "$OUTPUTS" | jq .
          
          # Extract key outputs (adjust based on your actual outputs)
          RESOURCE_GROUP=$(echo "$OUTPUTS" | jq -r '.resourceGroupName.value // empty')
          CONTAINER_ENV_ID=$(echo "$OUTPUTS" | jq -r '.containerAppsEnvironmentId.value // empty')
          KEY_VAULT_NAME=$(echo "$OUTPUTS" | jq -r '.keyVaultName.value // empty')
          LOG_ANALYTICS_WORKSPACE=$(echo "$OUTPUTS" | jq -r '.logAnalyticsWorkspaceName.value // empty')
          
          echo "resource-group=$RESOURCE_GROUP" >> $GITHUB_OUTPUT
          echo "container-env-id=$CONTAINER_ENV_ID" >> $GITHUB_OUTPUT
          echo "key-vault-name=$KEY_VAULT_NAME" >> $GITHUB_OUTPUT
          echo "log-analytics-workspace=$LOG_ANALYTICS_WORKSPACE" >> $GITHUB_OUTPUT

      - name: List Deployed Resources
        if: ${{ inputs.dry_run == false }}
        run: |
          echo "ðŸ“¦ Listing deployed resources in ${{ steps.outputs.outputs.resource-group }}..."
          az resource list \
            --resource-group "${{ steps.outputs.outputs.resource-group }}" \
            --output table

      - name: Test Container Apps Environment
        if: ${{ inputs.dry_run == false && steps.outputs.outputs.container-env-id != '' }}
        run: |
          echo "ðŸ§ª Testing Container Apps Environment..."
          ENV_ID="${{ steps.outputs.outputs.container-env-id }}"
          
          # Get environment details
          az containerapp env show \
            --ids "$ENV_ID" \
            --output table
          
          echo "âœ… Container Apps Environment is ready"

      - name: Test Key Vault Access
        if: ${{ inputs.dry_run == false && steps.outputs.outputs.key-vault-name != '' }}
        run: |
          echo "ðŸ” Testing Key Vault access..."
          VAULT_NAME="${{ steps.outputs.outputs.key-vault-name }}"
          
          # Test Key Vault connectivity
          az keyvault show \
            --name "$VAULT_NAME" \
            --output table
          
          echo "âœ… Key Vault is accessible"

      - name: Summary
        if: ${{ inputs.dry_run == false }}
        run: |
          echo "## âœ… Platform Infrastructure Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Region**: \`${{ inputs.location }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment**: \`${{ steps.deployment-name.outputs.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸŽ¯ Core Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | \`${{ steps.outputs.outputs.resource-group }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Apps Environment | \`${{ steps.outputs.outputs.container-env-id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Key Vault | \`${{ steps.outputs.outputs.key-vault-name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Log Analytics | \`${{ steps.outputs.outputs.log-analytics-workspace }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ï¿½ï¸ Database Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "| Database | FQDN |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| PostgreSQL (Product) | \`${{ steps.outputs.outputs.postgres-product-fqdn }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| PostgreSQL (User) | \`${{ steps.outputs.outputs.postgres-user-fqdn }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| PostgreSQL (Order) | \`${{ steps.outputs.outputs.postgres-order-fqdn }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| SQL Server | \`${{ steps.outputs.outputs.sql-server-fqdn }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| MySQL (Cart) | \`${{ steps.outputs.outputs.mysql-cart-fqdn }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Cosmos DB (MongoDB) | \`${{ steps.outputs.outputs.cosmos-resource-id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸš€ Messaging & Caching" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Service Bus | \`${{ steps.outputs.outputs.service-bus-namespace }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Redis Cache | \`${{ steps.outputs.outputs.redis-hostname }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ï¿½ðŸ“Š Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Bicep validation passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Parameter validation passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Infrastructure deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Post-deployment tests passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review deployed resources in Azure Portal" >> $GITHUB_STEP_SUMMARY
          echo "2. Configure application secrets in Key Vault" >> $GITHUB_STEP_SUMMARY
          echo "3. Deploy microservices to Container Apps" >> $GITHUB_STEP_SUMMARY
          echo "4. Configure custom domains and SSL certificates" >> $GITHUB_STEP_SUMMARY
          echo "5. Set up monitoring and alerts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Resource Group](https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ steps.outputs.outputs.resource-group }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Key Vault](https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ steps.outputs.outputs.resource-group }}/providers/Microsoft.KeyVault/vaults/${{ steps.outputs.outputs.key-vault-name }})" >> $GITHUB_STEP_SUMMARY

      - name: Dry Run Summary
        if: ${{ inputs.dry_run == true }}
        run: |
          echo "## ðŸ” Dry Run Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This was a dry run (what-if analysis). **No resources were created or modified.**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What-If Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "Review the what-if output above to see:" >> $GITHUB_STEP_SUMMARY
          echo "- Resources that will be created (ðŸŸ¢ Green)" >> $GITHUB_STEP_SUMMARY
          echo "- Resources that will be modified (ðŸŸ¡ Yellow)" >> $GITHUB_STEP_SUMMARY
          echo "- Resources that will be deleted (ðŸ”´ Red - should be none)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### To Deploy For Real" >> $GITHUB_STEP_SUMMARY
          echo "Run this workflow again with **dry_run = false**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Prerequisites Checklist" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Bootstrap infrastructure deployed (ACR exists)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Bicep modules published to ACR" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub secrets configured (AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Service principal has sufficient permissions" >> $GITHUB_STEP_SUMMARY

      - name: Deployment Failed
        if: failure()
        run: |
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The platform deployment encountered an error. Please review the logs above." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Common Issues" >> $GITHUB_STEP_SUMMARY
          echo "1. **Modules not published**: Run the Publish Bicep Modules workflow first" >> $GITHUB_STEP_SUMMARY
          echo "2. **Permission issues**: Verify service principal has Contributor access" >> $GITHUB_STEP_SUMMARY
          echo "3. **Resource naming conflicts**: Check for existing resources with same names" >> $GITHUB_STEP_SUMMARY
          echo "4. **Quota limits**: Verify Azure subscription has sufficient quota" >> $GITHUB_STEP_SUMMARY
          echo "5. **Parameter validation**: Ensure main.bicepparam has correct values" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Troubleshooting Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the detailed error message in the logs" >> $GITHUB_STEP_SUMMARY
          echo "2. Run the workflow with dry_run=true to see what-if analysis" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify prerequisites are complete" >> $GITHUB_STEP_SUMMARY
          echo "4. Review the Bicep template and parameters" >> $GITHUB_STEP_SUMMARY
