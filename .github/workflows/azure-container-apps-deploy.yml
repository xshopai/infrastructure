# ==============================================================================
# Deploy Azure Container Apps Infrastructure
# ==============================================================================
# This workflow deploys the shared infrastructure for xshopai platform:
# - Resource Group (created via Bicep at subscription scope)
# - Container Apps Environment with Dapr
# - Azure Service Bus (pub/sub)
# - Azure Cache for Redis (Dapr state store for cart-service)
# - Azure Cosmos DB (MongoDB API)
# - Azure SQL Server (for .NET services)
# - Azure PostgreSQL Flexible Server (for Java/Node services)
# - Azure MySQL Flexible Server (for Python services)
# - Azure Key Vault (secrets)
# - Azure Container Registry
# ==============================================================================

name: Deploy Azure Container Apps Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'
      location:
        description: 'Azure region'
        required: false
        type: string
        default: 'swedencentral'

  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'azure/container-apps/bicep/**'
  #     - '.github/workflows/azure-container-apps-deploy.yml'

permissions:
  id-token: write  # Required for OIDC authentication
  contents: read

# Note: Resource group name will be determined dynamically by Bicep template
# with unique suffix for global resource uniqueness

jobs:
  validate:
    name: Validate Bicep
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Validate Bicep template
        run: |
          az bicep build --file azure/container-apps/bicep/deploy.bicep
          az bicep build --file azure/container-apps/bicep/main.bicep
          echo "‚úÖ Bicep validation passed"

  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: validate
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    outputs:
      containerAppsEnvName: ${{ steps.deploy.outputs.containerAppsEnvName }}
      acrLoginServer: ${{ steps.deploy.outputs.acrLoginServer }}
      keyVaultUri: ${{ steps.deploy.outputs.keyVaultUri }}
      resourceGroupName: ${{ steps.deploy.outputs.resourceGroupName }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Infrastructure (Subscription Scope)
        id: deploy-sub
        run: |
          DEPLOYMENT_NAME="xshopai-infra-${{ github.run_number }}"
          
          az deployment sub create \
            --name $DEPLOYMENT_NAME \
            --location ${{ github.event.inputs.location || 'swedencentral' }} \
            --template-file ./azure/container-apps/bicep/deploy.bicep \
            --parameters environment=${{ github.event.inputs.environment || 'dev' }} \
            --parameters location=${{ github.event.inputs.location || 'swedencentral' }} \
            --parameters postgresAdminLogin=xshopaiadmin \
            --parameters postgresAdminPassword=${{ secrets.POSTGRES_ADMIN_PASSWORD }} \
            --parameters sqlServerAdminLogin=xshopaiadmin \
            --parameters sqlServerAdminPassword=${{ secrets.SQL_SERVER_ADMIN_PASSWORD }} \
            --parameters mysqlAdminLogin=xshopaiadmin \
            --parameters mysqlAdminPassword=${{ secrets.MYSQL_ADMIN_PASSWORD }} \
            --parameters sqlAzureAdAdminObjectId=${{ secrets.SQL_AZURE_AD_ADMIN_OBJECT_ID || '' }} \
            --parameters sqlAzureAdAdminLogin="${{ secrets.SQL_AZURE_AD_ADMIN_LOGIN || '' }}" \
            --parameters deploymentSuffix="run${{ github.run_number }}"
          
          # Get outputs
          RG_NAME=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.resourceGroupName.value -o tsv)
          
          CAE_NAME=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.containerAppsEnvName.value -o tsv)
          
          ACR_SERVER=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.acrLoginServer.value -o tsv)
          
          KV_URI=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.keyVaultUri.value -o tsv)
          
          CAE_DOMAIN=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.containerAppsEnvDomain.value -o tsv)
          
          # Set outputs
          echo "resourceGroupName=$RG_NAME" >> $GITHUB_OUTPUT
          echo "containerAppsEnvName=$CAE_NAME" >> $GITHUB_OUTPUT
          echo "acrLoginServer=$ACR_SERVER" >> $GITHUB_OUTPUT
          echo "keyVaultUri=$KV_URI" >> $GITHUB_OUTPUT
          echo "containerAppsEnvDomain=$CAE_DOMAIN" >> $GITHUB_OUTPUT

      - name: Set Outputs
        id: deploy
        run: |
          # Get outputs from subscription deployment
          RG_NAME="${{ steps.deploy-sub.outputs.resourceGroupName }}"
          CAE_NAME="${{ steps.deploy-sub.outputs.containerAppsEnvName }}"
          ACR_SERVER="${{ steps.deploy-sub.outputs.acrLoginServer }}"
          KV_URI="${{ steps.deploy-sub.outputs.keyVaultUri }}"
          CAE_DOMAIN="${{ steps.deploy-sub.outputs.containerAppsEnvDomain }}"
          
          echo "resourceGroupName=$RG_NAME" >> $GITHUB_OUTPUT
          echo "containerAppsEnvName=$CAE_NAME" >> $GITHUB_OUTPUT
          echo "acrLoginServer=$ACR_SERVER" >> $GITHUB_OUTPUT
          echo "keyVaultUri=$KV_URI" >> $GITHUB_OUTPUT
          
          # Summary
          echo "### üöÄ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ github.event.inputs.environment || 'dev' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Resource Group** | $RG_NAME |" >> $GITHUB_STEP_SUMMARY
          echo "| **Container Apps Env** | $CAE_NAME |" >> $GITHUB_STEP_SUMMARY
          echo "| **Container Apps Domain** | $CAE_DOMAIN |" >> $GITHUB_STEP_SUMMARY
          echo "| **Container Registry** | $ACR_SERVER |" >> $GITHUB_STEP_SUMMARY
          echo "| **Key Vault** | $KV_URI |" >> $GITHUB_STEP_SUMMARY

      - name: Azure Logout
        if: always()
        run: az logout

  notify:
    name: Notify Completion
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Post Summary
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Infrastructure deployment completed successfully!"
            echo ""
            echo "Next steps:"
            echo "1. Deploy services using their respective workflows"
            echo "2. Configure DNS if custom domain is needed"
            echo "3. Verify Dapr components are working"
          else
            echo "‚ùå Infrastructure deployment failed!"
            echo "Check the deploy job logs for details."
            exit 1
          fi
