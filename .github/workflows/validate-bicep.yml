# ==============================================================================
# Validate Bicep Templates
# ==============================================================================
# Runs on PRs to validate all Bicep modules and templates
# ==============================================================================

name: Validate Bicep

on:
  pull_request:
    branches:
      - main
    paths:
      - '**/*.bicep'
      - '**/*.bicepparam'

  push:
    branches:
      - main
    paths:
      - '**/*.bicep'
      - '**/*.bicepparam'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    name: Validate Bicep Templates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bicep
        run: |
          az bicep install
          az bicep version

      - name: Validate Bicep Modules
        run: |
          echo "Validating Bicep modules..."
          FAILED=0
          
          # Validate all modules
          for module in azure/container-apps/bicep/modules/*.bicep; do
            if [ -f "$module" ]; then
              echo "Validating $(basename $module)..."
              if ! az bicep build --file "$module" --stdout > /dev/null 2>&1; then
                echo "âŒ Failed: $module"
                FAILED=1
              else
                echo "âœ… $(basename $module)"
              fi
            fi
          done
          
          # Validate dev/bootstrap
          if [ -f "azure/container-apps/bicep/dev/bootstrap/main.bicep" ]; then
            echo "Validating dev/bootstrap/main.bicep..."
            if ! az bicep build --file azure/container-apps/bicep/dev/bootstrap/main.bicep --stdout > /dev/null 2>&1; then
              echo "âŒ Failed: dev/bootstrap/main.bicep"
              FAILED=1
            else
              echo "âœ… dev/bootstrap/main.bicep"
            fi
            
            # Validate bicepparam file
            if [ -f "azure/container-apps/bicep/dev/bootstrap/main.bicepparam" ]; then
              echo "Validating dev/bootstrap/main.bicepparam syntax..."
              # Basic syntax check (full validation requires resource group)
              if ! az bicep build-params --file azure/container-apps/bicep/dev/bootstrap/main.bicepparam --stdout > /dev/null 2>&1; then
                echo "âŒ Failed: dev/bootstrap/main.bicepparam"
                FAILED=1
              else
                echo "âœ… dev/bootstrap/main.bicepparam"
              fi
            fi
          fi
          
          # Validate dev/platform
          if [ -f "azure/container-apps/bicep/dev/platform/main.bicep" ]; then
            echo "Validating dev/platform/main.bicep..."
            if ! az bicep build --file azure/container-apps/bicep/dev/platform/main.bicep --stdout > /dev/null 2>&1; then
              echo "âŒ Failed: dev/platform/main.bicep"
              FAILED=1
            else
              echo "âœ… dev/platform/main.bicep"
            fi
            
            # Validate bicepparam file
            if [ -f "azure/container-apps/bicep/dev/platform/main.bicepparam" ]; then
              echo "Validating dev/platform/main.bicepparam syntax..."
              if ! az bicep build-params --file azure/container-apps/bicep/dev/platform/main.bicepparam --stdout > /dev/null 2>&1; then
                echo "âŒ Failed: dev/platform/main.bicepparam"
                FAILED=1
              else
                echo "âœ… dev/platform/main.bicepparam"
              fi
            fi
          fi
          
          # Validate prod templates (if folder exists)
          if [ -d "azure/container-apps/bicep/prod" ]; then
            echo "Validating prod templates..."
            for dir in azure/container-apps/bicep/prod/*/; do
              if [ -f "${dir}main.bicep" ]; then
                echo "Validating prod/$(basename $dir)/main.bicep..."
                if ! az bicep build --file "${dir}main.bicep" --stdout > /dev/null 2>&1; then
                  echo "âŒ Failed: prod/$(basename $dir)/main.bicep"
                  FAILED=1
                else
                  echo "âœ… prod/$(basename $dir)/main.bicep"
                fi
                
                # Validate bicepparam file
                if [ -f "${dir}main.bicepparam" ]; then
                  echo "Validating prod/$(basename $dir)/main.bicepparam syntax..."
                  if ! az bicep build-params --file "${dir}main.bicepparam" --stdout > /dev/null 2>&1; then
                    echo "âŒ Failed: prod/$(basename $dir)/main.bicepparam"
                    FAILED=1
                  else
                    echo "âœ… prod/$(basename $dir)/main.bicepparam"
                  fi
                fi
              fi
            done
          else
            echo "ðŸ“Š Prod folder not yet created (skipping)"
          fi
          
          if [ $FAILED -eq 1 ]; then
            echo "âŒ Validation failed"
            exit 1
          fi
          
          echo "âœ… All Bicep templates are valid"

      - name: Post validation summary
        run: |
          echo "### âœ… Bicep Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Bicep templates are syntactically valid." >> $GITHUB_STEP_SUMMARY
