# ==============================================================================
# Validate Bicep Templates
# ==============================================================================
# Runs on PRs to validate all Bicep modules and templates
# ==============================================================================

name: Validate Bicep

on:
  pull_request:
    branches:
      - main
    paths:
      - '**/*.bicep'
      - '**/*.bicepparam'

  push:
    branches:
      - main
    paths:
      - '**/*.bicep'
      - '**/*.bicepparam'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    name: Validate Bicep Templates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bicep
        run: |
          az bicep install
          az bicep version

      - name: Validate Bicep Modules
        run: |
          echo "Validating Bicep modules..."
          FAILED=0
          
          # Validate all modules
          for module in azure/container-apps/bicep/modules/*.bicep; do
            if [ -f "$module" ]; then
              echo "Validating $(basename $module)..."
              if ! az bicep build --file "$module" --stdout > /dev/null 2>&1; then
                echo "❌ Failed: $module"
                FAILED=1
              else
                echo "✅ $(basename $module)"
              fi
            fi
          done
          
          # Validate bicep-registry
          if [ -f "azure/container-apps/bicep/bicep-registry/main.bicep" ]; then
            echo "Validating bicep-registry/main.bicep..."
            if ! az bicep build --file azure/container-apps/bicep/bicep-registry/main.bicep --stdout > /dev/null 2>&1; then
              echo "❌ Failed: bicep-registry/main.bicep"
              FAILED=1
            else
              echo "✅ bicep-registry/main.bicep"
            fi
          fi
          
          if [ $FAILED -eq 1 ]; then
            echo "❌ Validation failed"
            exit 1
          fi
          
          echo "✅ All Bicep templates are valid"

      - name: Post validation summary
        run: |
          echo "### ✅ Bicep Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Bicep templates are syntactically valid." >> $GITHUB_STEP_SUMMARY
