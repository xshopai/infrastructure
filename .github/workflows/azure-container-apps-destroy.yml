# ==============================================================================
# Destroy Azure Container Apps Infrastructure
# ==============================================================================
# WARNING: This workflow will DELETE all resources in the resource group!
# Use with caution - this is irreversible.
# ==============================================================================

name: Destroy Azure Container Apps Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to destroy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      confirmation:
        description: 'Type "DESTROY" to confirm'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

env:
  AZURE_RESOURCE_GROUP: rg-xshopai-${{ github.event.inputs.environment }}

jobs:
  validate:
    name: Validate Confirmation
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        if: github.event.inputs.confirmation != 'DESTROY'
        run: |
          echo "âŒ Confirmation failed. You must type 'DESTROY' to confirm."
          exit 1

      - name: Production warning
        if: github.event.inputs.environment == 'prod'
        run: |
          echo "âš ï¸ WARNING: You are about to destroy PRODUCTION infrastructure!"
          echo "This action is irreversible and will delete all data."
          sleep 10

  destroy:
    name: Destroy Resources
    runs-on: ubuntu-latest
    needs: validate
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Check Resource Group exists
        id: check
        run: |
          if az group show --name ${{ env.AZURE_RESOURCE_GROUP }} &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Resource group ${{ env.AZURE_RESOURCE_GROUP }} does not exist."
          fi

      - name: Delete Resource Group
        if: steps.check.outputs.exists == 'true'
        run: |
          echo "ðŸ—‘ï¸ Deleting resource group: ${{ env.AZURE_RESOURCE_GROUP }}"
          az group delete \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --yes \
            --no-wait
          
          echo "### âš ï¸ Resource Group Deletion Initiated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Resource group **${{ env.AZURE_RESOURCE_GROUP }}** is being deleted." >> $GITHUB_STEP_SUMMARY
          echo "This may take several minutes to complete." >> $GITHUB_STEP_SUMMARY

      - name: Azure Logout
        if: always()
        run: az logout
